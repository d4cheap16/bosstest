<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOSS Hybrid Animator (Sprite + Procedural)</title>
    <style>
        body {
            background-color: #111; color: #ddd; font-family: 'Segoe UI', monospace;
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        
        /* --- é è¦½èˆå°å€ --- */
        #stage {
            flex: 1; display: flex; align-items: flex-end; justify-content: center;
            background: radial-gradient(circle at center bottom, #333 0%, #000 80%);
            padding-bottom: 80px; border-bottom: 2px solid #500; position: relative;
            overflow: hidden;
        }

        /* ç¶²æ ¼èƒŒæ™¯ (åƒè€ƒç”¨) */
        #stage::before {
            content: " "; position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: linear-gradient(#222 1px, transparent 1px), linear-gradient(90deg, #222 1px, transparent 1px);
            background-size: 50px 50px; opacity: 0.3; pointer-events: none;
        }

        /* åœ–ç‰‡å®¹å™¨ - ç”¨æ–¼è™•ç†éœ‡å‹•ç‰¹æ•ˆ */
        #boss-wrapper {
            position: relative;
            display: flex; justify-content: center; align-items: flex-end;
        }

        /* åœ–ç‰‡æœ¬é«” - è² è²¬ç¸®æ”¾èˆ‡å‘¼å¸ */
        #boss-img {
            image-rendering: pixelated; 
            transform-origin: bottom center; /* å‘¼å¸å¾åº•éƒ¨é–‹å§‹ */
            width: 150px; 
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.8));
            transition: filter 0.1s;
        }

        /* è³‡è¨Š HUD */
        #hud { 
            position: absolute; top: 15px; left: 15px; 
            font-family: monospace; font-size: 14px; 
            background: rgba(0,0,0,0.7); padding: 10px; border: 1px solid #444; border-radius: 4px;
            pointer-events: none;
        }
        .status-idle { color: #8f8; }
        .status-ready { color: #fa0; }
        .status-attack { color: #f44; font-weight: bold; text-shadow: 0 0 10px red; }
        .status-damage { color: #f8f; font-weight: bold; text-shadow: 0 0 10px magenta; }

        /* --- æ§åˆ¶é¢æ¿å€ --- */
        #controls {
            background: #181818; padding: 10px 20px; border-top: 1px solid #444;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .panel-group {
            border: 1px solid #333; padding: 10px; border-radius: 6px; background: #222;
        }
        .panel-title { font-size: 12px; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; border-bottom: 1px solid #444; padding-bottom: 4px; }

        .btn-row { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 5px; }
        
        button, label, input[type="number"] {
            font-family: inherit; font-size: 12px;
        }
        
        button {
            padding: 8px 12px; background: #333; border: 1px solid #555; color: #fff;
            cursor: pointer; border-radius: 4px; transition: 0.2s;
            flex: 1;
        }
        button:hover:not(:disabled) { background: #555; border-color: #999; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.primary { background: #522; border-color: #844; }
        button.primary:hover:not(:disabled) { background: #722; border-color: #a66; }

        label {
            display: flex; align-items: center; justify-content: space-between;
            background: #2a2a2a; padding: 5px 10px; border-radius: 4px; margin-bottom: 4px; cursor: pointer; border: 1px dashed #444;
        }
        label:hover { border-color: #666; background: #333; }
        input[type="file"] { display: none; }

        .param-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
        .param-row span { font-size: 12px; color: #aaa; }
        input[type="number"] {
            width: 60px; background: #111; border: 1px solid #444; color: #0f0; padding: 4px; text-align: right;
        }

        /* CSS ç‰¹æ•ˆé¡ */
        .flash { filter: brightness(5) sepia(1) saturate(5) hue-rotate(-50deg) drop-shadow(0 0 20px red) !important; }
        
    </style>
</head>
<body>

    <div id="stage">
        <div id="hud">
            <div>STATE: <span id="status-text" class="status-idle">IDLE</span></div>
            <div>Z-Depth: <span id="z-val">0.20</span></div>
            <div>Active Img: <span id="img-src-debug">None</span></div>
        </div>

        <div id="boss-wrapper">
            <img id="boss-img" src="" alt="è«‹åœ¨ä¸‹æ–¹è¼‰å…¥åœ–ç‰‡" onerror="this.style.opacity=0.2">
        </div>
    </div>

    <div id="controls">
        
        <!-- 1. åœ–ç‰‡è³‡æºç®¡ç† -->
        <div class="panel-group">
            <div class="panel-title">1. Assets (åœ–ç‰‡è³‡æº)</div>
            <label>ğŸ“‚ å¾…æ©Ÿå‹•ä½œ A (Idle 1) <input type="file" onchange="loadImg(this, 'idle', 0)"></label>
            <label>ğŸ“‚ å¾…æ©Ÿå‹•ä½œ B (Idle 2) <input type="file" onchange="loadImg(this, 'idle', 1)"></label>
            <label>ğŸ“‚ æ”»æ“Šé å‚™ (Ready) <input type="file" onchange="loadImg(this, 'ready', 0)"></label>
            <label>ğŸ“‚ æ”»æ“Šç¬é–“ (Attack) <input type="file" onchange="loadImg(this, 'attack', 0)"></label>
            <label style="border-color: #844;">ğŸ“‚ å—å‚·/åƒµç›´ (Damage) <input type="file" onchange="loadImg(this, 'damage', 0)"></label>
        </div>

        <!-- 2. åƒæ•¸èª¿æ ¡ -->
        <div class="panel-group">
            <div class="panel-title">2. Parameters (åƒæ•¸èª¿æ ¡)</div>
            
            <div class="param-row">
                <span>å¾…æ©Ÿå¾ªç’° (ms)</span>
                <input type="number" id="inp-idle-spd" value="500" step="50" onchange="updateParams()">
            </div>
            <div class="param-row">
                <span>è“„åŠ›æ™‚é–“ (Ready ms)</span>
                <input type="number" id="inp-ready-time" value="600" step="50" onchange="updateParams()">
            </div>
            <div class="param-row">
                <span>æ”»æ“Šåˆ¤å®š (Attack ms)</span>
                <input type="number" id="inp-attack-time" value="300" step="50" onchange="updateParams()">
            </div>
            <div class="param-row">
                <span>å—å‚·ç¡¬ç›´ (Damage ms)</span>
                <input type="number" id="inp-damage-time" value="400" step="50" onchange="updateParams()">
            </div>

            <div class="param-row" style="border-top: 1px solid #333; padding-top:5px; margin-top:5px;">
                <span>å‘¼å¸å¹…åº¦ (0~0.1)</span>
                <input type="number" id="inp-breath-amp" value="0.03" step="0.01" onchange="updateParams()">
            </div>
            <div class="param-row">
                <span>èµ°è·¯æ™ƒå‹• (px)</span>
                <input type="number" id="inp-wobble-amp" value="5" step="1" onchange="updateParams()">
            </div>
        </div>

        <!-- 3. å‹•ä½œæ¸¬è©¦ -->
        <div class="panel-group">
            <div class="panel-title">3. Actions (å‹•ä½œæ¸¬è©¦)</div>
            <div class="btn-row">
                <button onclick="changeZ(0.1)">â« å‰é€² (Near)</button>
                <button onclick="changeZ(-0.1)">â¬ å¾Œé€€ (Far)</button>
            </div>
            <div class="btn-row">
                <button id="btn-attack" class="primary" onclick="startAttackSequence()">âš”ï¸ åŸ·è¡Œæ”»æ“Š (Attack)</button>
            </div>
            <div class="btn-row">
                <button onclick="triggerDamage()" style="border-color: #844; color:#f88;">ğŸ’¥ å—å‚·æ¸¬è©¦ (Damage)</button>
            </div>
        </div>

    </div>

    <script>
        // DOM å…ƒç´ 
        const imgEl = document.getElementById('boss-img');
        const wrapperEl = document.getElementById('boss-wrapper');
        const zEl = document.getElementById('z-val');
        const statusText = document.getElementById('status-text');
        const debugSrc = document.getElementById('img-src-debug');
        const btnAttack = document.getElementById('btn-attack');

        // åœ–ç‰‡åº«
        const assets = {
            idle: [null, null],
            ready: [null],
            attack: [null],
            damage: [null] // æ–°å¢å—å‚·åœ–ç‰‡æ§½ä½
        };

        // æ ¸å¿ƒåƒæ•¸ (æœƒå¾ UI è®€å–)
        let config = {
            idleLoopSpeed: 500,
            readyDuration: 600,
            attackDuration: 300,
            damageDuration: 400, // æ–°å¢å—å‚·æ™‚é–“
            breatheAmp: 0.03,    // å‘¼å¸ç¸®æ”¾æ¯”ä¾‹
            breatheSpeed: 0.003, // å‘¼å¸é€Ÿåº¦ä¿‚æ•¸
            wobbleAmp: 5,        // èµ°è·¯ä¸Šä¸‹æ™ƒå‹•åƒç´ 
            wobbleSpeed: 0.008   // èµ°è·¯é€Ÿåº¦ä¿‚æ•¸
        };

        // ç‹€æ…‹è®Šæ•¸
        let z = 0.2;
        let currentState = 'IDLE'; // IDLE, READY, ATTACK, DAMAGE
        let idleFrameIndex = 0;
        let idleInterval = null;
        let motionFrameId = null;
        let damageShake = 0; // å—å‚·éœ‡å‹•å¼·åº¦
        let actionTimeout = null; // ç”¨ä¾†ç®¡ç†æ”»æ“Šæˆ–å—å‚·çš„è¨ˆæ™‚å™¨ï¼Œæ–¹ä¾¿éš¨æ™‚ä¸­æ–·

        // --- 1. è³‡æºè¼‰å…¥ ---
        function loadImg(input, type, index) {
            if (input.files && input.files[0]) {
                const url = URL.createObjectURL(input.files[0]);
                assets[type][index] = url;
                
                // UX: è¼‰å…¥å¾Œè‡ªå‹•å˜—è©¦é¡¯ç¤º
                if (type === 'idle' && currentState === 'IDLE') updateSprite();
                
                // è‹¥é€™æ˜¯ç¬¬ä¸€å¼µåœ–ï¼Œå•Ÿå‹•å¾ªç’°
                if (!idleInterval) startSystem();
            }
        }

        // --- 2. åƒæ•¸æ›´æ–° ---
        function updateParams() {
            config.idleLoopSpeed = parseInt(document.getElementById('inp-idle-spd').value) || 500;
            config.readyDuration = parseInt(document.getElementById('inp-ready-time').value) || 600;
            config.attackDuration = parseInt(document.getElementById('inp-attack-time').value) || 300;
            config.damageDuration = parseInt(document.getElementById('inp-damage-time').value) || 400;
            config.breatheAmp = parseFloat(document.getElementById('inp-breath-amp').value) || 0.03;
            config.wobbleAmp = parseFloat(document.getElementById('inp-wobble-amp').value) || 5;

            // é‡å•Ÿ Idle Loop ä»¥å¥—ç”¨æ–°é€Ÿåº¦
            if (idleInterval) {
                clearInterval(idleInterval);
                startIdleLoop();
            }
        }

        // --- 3. æ ¸å¿ƒå¾ªç’°ç³»çµ± (Hybrid Engine) ---
        function startSystem() {
            startIdleLoop();        // è² è²¬åˆ‡æ›åœ–ç‰‡ (Sprite Animation)
            startProceduralMotion(); // è² è²¬æ•¸å­¸è¨ˆç®—å‹•æ…‹ (Procedural Animation)
        }

        // A. åœ–ç‰‡åˆ‡æ›å¾ªç’°
        function startIdleLoop() {
            if (idleInterval) clearInterval(idleInterval);
            idleInterval = setInterval(() => {
                if (currentState === 'IDLE') {
                    idleFrameIndex = (idleFrameIndex + 1) % 2;
                    updateSprite();
                }
            }, config.idleLoopSpeed);
        }

        // B. ç¨‹å¼åŒ–å‹•æ…‹å¾ªç’° (ç„¡æ®µè®Šé€Ÿå‘¼å¸èˆ‡æ™ƒå‹•)
        function startProceduralMotion() {
            if (motionFrameId) cancelAnimationFrame(motionFrameId);

            function loop() {
                const now = Date.now();
                
                // 1. è¨ˆç®—å‘¼å¸ (Scale Y)
                // æ”»æ“Šæˆ–å—å‚·æ™‚å‘¼å¸æ”¹è®Š
                const isAggro = currentState !== 'IDLE';
                const bSpeed = isAggro ? config.breatheSpeed * 4 : config.breatheSpeed;
                const bAmp = isAggro ? config.breatheAmp * 0.5 : config.breatheAmp;
                
                // å—å‚·æ™‚æš«åœå‘¼å¸æˆ–è®Šå¾—éå¸¸æ€¥ä¿ƒï¼Œé€™è£¡é¸æ“‡è®Šå°
                let breatheScale = 1 + Math.sin(now * bSpeed) * bAmp;
                if (currentState === 'DAMAGE') breatheScale = 1.0; 

                // 2. è¨ˆç®—èµ°è·¯æ™ƒå‹• (Translate Y)
                // æ”»æ“Šæ™‚é€šå¸¸ç«™å®šä¸å‹•ï¼Œæ‰€ä»¥æ™ƒå‹•æ­¸é›¶
                let wobbleY = 0;
                if (currentState === 'IDLE') {
                    wobbleY = Math.abs(Math.sin(now * config.wobbleSpeed)) * config.wobbleAmp;
                }

                // 3. è¨ˆç®—å—å‚·éœ‡å‹• (Shake)
                let shakeX = 0;
                let shakeY = 0;
                if (damageShake > 0) {
                    shakeX = (Math.random() - 0.5) * damageShake;
                    shakeY = (Math.random() - 0.5) * damageShake;
                    damageShake *= 0.9; // è¡°æ¸›
                    if (damageShake < 0.5) damageShake = 0;
                }

                // 4. æ”»æ“Šæ™‚çš„é¡å¤–æ•ˆæœ (Impact Scale)
                const impactScale = (currentState === 'ATTACK') ? 1.15 : 1.0;

                // 5. ç¶œåˆæ‡‰ç”¨åˆ° CSS
                // å‘¼å¸èˆ‡è¡æ“Šæ‡‰ç”¨åœ¨ Scaleï¼Œèµ°è·¯èˆ‡éœ‡å‹•æ‡‰ç”¨åœ¨ Translate
                const finalScale = breatheScale * impactScale;
                const finalY = -wobbleY + shakeY;
                const finalX = shakeX;

                imgEl.style.transform = `translate(${finalX}px, ${finalY}px) scale(${finalScale})`;

                motionFrameId = requestAnimationFrame(loop);
            }
            loop();
        }

        // --- 4. é¡¯ç¤ºæ›´æ–°é‚è¼¯ ---
        function updateSprite() {
            let src = null;
            let debugTag = "";

            if (currentState === 'IDLE') {
                src = assets.idle[idleFrameIndex] || assets.idle[0];
                debugTag = `Idle[${idleFrameIndex}]`;
                statusText.className = 'status-idle';
            } else if (currentState === 'READY') {
                src = assets.ready[0] || assets.idle[0]; // ç¼ºåœ–å°±ç”¨ Idle é ‚æ›¿
                debugTag = `Ready`;
                statusText.className = 'status-ready';
            } else if (currentState === 'ATTACK') {
                src = assets.attack[0] || assets.idle[0];
                debugTag = `Attack`;
                statusText.className = 'status-attack';
            } else if (currentState === 'DAMAGE') {
                src = assets.damage[0] || assets.idle[0]; // ç¼ºåœ–ç”¨ Idle
                debugTag = `Damage`;
                statusText.className = 'status-damage';
            }

            statusText.innerText = currentState;
            
            if (src) {
                // åªæœ‰ç•¶åœ–ç‰‡è·¯å¾‘æ”¹è®Šæ™‚æ‰è¨­å®šï¼Œç¯€çœç€è¦½å™¨é‡ç¹ªæ•ˆèƒ½
                const currentSrc = imgEl.getAttribute('src');
                if (currentSrc !== src) {
                    imgEl.src = src;
                    imgEl.style.opacity = 1;
                }
                debugSrc.innerText = debugTag;
            } else {
                debugSrc.innerText = "No Image";
            }
        }

        // --- 5. äº’å‹•åŠŸèƒ½ ---

        // è§¸ç™¼æ”»æ“Šåºåˆ—
        function startAttackSequence() {
            if (currentState !== 'IDLE') return; // é˜²æ­¢é‡è¤‡è§¸ç™¼

            // é–å®šæŒ‰éˆ•
            btnAttack.disabled = true;
            btnAttack.innerHTML = "âš ï¸ è“„åŠ›ä¸­...";

            // Phase 1: Ready
            currentState = 'READY';
            updateSprite();

            // ä½¿ç”¨å…¨å±€è®Šæ•¸å­˜å„² Timeoutï¼Œä»¥ä¾¿å—å‚·æ™‚å¯ä»¥ä¸­æ–·
            actionTimeout = setTimeout(() => {
                // Phase 2: Attack
                currentState = 'ATTACK';
                btnAttack.innerHTML = "âš”ï¸ æ”»æ“Š!";
                updateSprite();
                
                // æ”»æ“Šç¬é–“å¯ä»¥åŠ ä¸€é»éœ‡å‹•
                damageShake = 10; 

                actionTimeout = setTimeout(() => {
                    resetToIdle();
                }, config.attackDuration);

            }, config.readyDuration);
        }

        // è§¸ç™¼å—å‚· (ä¸­æ–·ä»»ä½•å‹•ä½œ)
        function triggerDamage() {
            // 1. ä¸­æ–·ç•¶å‰è¨ˆæ™‚å™¨ (ä¾‹å¦‚æ­£åœ¨è“„åŠ›æ”»æ“Š)
            if (actionTimeout) clearTimeout(actionTimeout);
            
            // 2. è¨­å®šç‹€æ…‹
            currentState = 'DAMAGE';
            updateSprite();
            
            // 3. ç‰¹æ•ˆ
            imgEl.classList.add('flash');
            damageShake = 20; // å¼·çƒˆéœ‡å‹•
            
            // 4. é‡è¨­æŒ‰éˆ• UI (å¦‚æœæ”»æ“Šè¢«ä¸­æ–·)
            btnAttack.disabled = false;
            btnAttack.innerHTML = "âš”ï¸ åŸ·è¡Œæ”»æ“Š (Attack)";

            // 5. è¨­å®šå›å¾©æ™‚é–“
            setTimeout(() => {
                imgEl.classList.remove('flash');
            }, 150);

            actionTimeout = setTimeout(() => {
                resetToIdle();
            }, config.damageDuration);
        }

        // å›å¾©åˆ° IDLE çš„å…±ç”¨å‡½å¼
        function resetToIdle() {
            currentState = 'IDLE';
            btnAttack.disabled = false;
            btnAttack.innerHTML = "âš”ï¸ åŸ·è¡Œæ”»æ“Š (Attack)";
            updateSprite();
        }

        // èª¿æ•´è·é›¢ (å¤§å°)
        function changeZ(delta) {
            z = Math.max(0.05, Math.min(1.5, z + delta));
            // è·é›¢å…¬å¼ï¼šè·é›¢è¶Šè¿‘(Zè¶Šå°?) é€™è£¡åéä¾† Zè¶Šå¤§è¶Šè¿‘
            const width = 50 + (z * z * 400); 
            imgEl.style.width = width + "px";
            zEl.innerText = z.toFixed(2);
        }

        // åˆå§‹åŒ–
        changeZ(0);
        // è‹¥æ²’æœ‰ä¸Šå‚³åœ–ç‰‡ï¼Œæš«ä¸å•Ÿå‹• Loopï¼Œç­‰å¾…ä¸Šå‚³
    </script>
</body>
</html>
